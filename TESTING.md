# App-Gateway2 Testing Guide

## Overview
This guide explains how testing is organized for the app-gateway2 repository. The project provides:
- Unit and component tests for AppGateway and related modules, built and executed with CMake/CTest.
- A lightweight test-only Thunder plugin (App2AppProviderTest.so) to facilitate integration flows with a running Thunder (WPEFramework) instance.

The goal is to validate internal logic (resolution, routing, and caches) and to support realistic provider-to-gateway interactions common in Firebolt provider patterns.

## Test Types
### Unit tests
Unit tests exercise small, focused logic such as ResolutionStore overlays, Resolver path loading, and OttPermissionCache persistence and idempotency.

### Component tests
Component tests validate interactions across multiple classes, such as RequestRouter echoing resolved requests with parameters.

### Integration tests (plugin-level)
An App2AppProvider test plugin is provided to load in a Thunder runtime and interact with the AppGateway plugin. This enables end-to-end provider registration, resolution, and response scenarios. These are run manually or within a suitable Thunder runtime; they are not wired to CTest.

## Directory Structure
### Top-level testing areas
- app-gateway2/app-gateway/tests
  - CMakeLists.txt: Defines test executables and registers them with CTest. Locates Thunder headers and libraries from dependencies/install and links against WPEFrameworkCore and WPEFrameworkPlugins. It also links to the AppGateway plugin target if present.
  - test_appgateway.cpp: Exercises ResolutionStore, Resolver, and RequestRouter.
  - test_fbcommon.cpp: Validates FbCommon resolution overlays and event mapping via Resolver.
  - test_ottpermissioncache.cpp: Validates OttPermissionCache behavior and file format idempotency.

- app-gateway2/app-gateway2_testing
  - CMakeLists.txt: Builds a shared library named App2AppProviderTest from sources and links against WPEFrameworkCore and WPEFrameworkPlugins located under dependencies/install.
  - App2AppProvider/
    - App2AppProvider.cpp / .h: Thunder PluginHost::IPlugin wrapper that queries AppGateway by callsign via IShell.
    - App2AppProviderImplementation.cpp / .h: Implements a minimal Exchange::IApp2AppProvider for exercising provider patterns.
    - IApp2AppProvider.h: Local Exchange interface definitions tailored for testing.
    - Module.cpp and UtilsLogging.h: Module declaration and basic logging for the plugin.

### Generated build tree (example)
- app-gateway2/build-ottservices/tests/CTestTestfile.cmake: Generated by CMake. Contains test registrations for CTest (e.g., AppGateway.Basic, FbCommon.Resolutions, OttPermissionCache.Idempotent).

## Tooling and Frameworks
- Build: CMake (CMakeLists under tests and plugin).
- Test driver: CTest (add_test used in app-gateway/tests/CMakeLists.txt).
- Assertion style: Plain C++ with std::cout/std::cerr checks and nonzero exit codes for failures. There is no GoogleTest/Catch2 detected in this repository.
- Thunder/WPEFramework: Headers and libraries are expected under dependencies/install.

Relevant files:
- app-gateway2/app-gateway/tests/CMakeLists.txt
- app-gateway2/app-gateway2_testing/CMakeLists.txt

## How to Build and Run Tests
### Prerequisites
- Thunder (WPEFramework) headers and libraries present at app-gateway2/dependencies/install:
  - include/WPEFramework
  - lib/WPEFrameworkCore, lib/WPEFrameworkPlugins
- CMake 3.10+ and a C++ toolchain with C++11 (tests) and C++17 (plugin) support.

### Configure and build the unit/component tests
Commands:
- mkdir -p app-gateway2/build-ottservices
- cd app-gateway2/build-ottservices
- cmake ..        # or: cmake -S .. -B .
- cmake --build .

Run the full test suite with verbosity:
- ctest --output-on-failure

Run a specific test by name:
- ctest -R AppGateway.Basic --output-on-failure
- ctest -R FbCommon.Resolutions --output-on-failure
- ctest -R OttPermissionCache.Idempotent --output-on-failure

Increase CTest verbosity:
- ctest -V
- ctest -VV

### Build the integration test plugin
Commands:
- cd app-gateway2/app-gateway2_testing
- mkdir -p build && cd build
- cmake ..
- cmake --build .

This produces App2AppProviderTest.so in the build directory (without lib prefix). To use it, load the .so in a Thunder environment where the AppGateway plugin is running. The plugin attempts to access AppGateway via QueryInterfaceByCallsign using "org.rdk.AppGateway" and falls back to "AppGateway".

## Test Data and Fixtures
- Temporary overlay JSON files are created under /tmp by tests (e.g., fbcommon_resolver_test.json, appgateway_resolver_test.json). Tests clean up these files on best effort.
- OttPermissionCache tests use an environment variable OTT_PERMS_FILE to redirect output to a test-specific file in /tmp and ensure isolation between runs.

## Environment and Configuration
- NAMESPACE: Tests default to NAMESPACE=WPEFramework if not specified.
- Thunder paths: app-gateway/tests/CMakeLists.txt computes the Thunder install path relative to the repository if THUNDER_INSTALL_PATH_ABS is not provided. Override these if your environment differs:
  - -DTHUNDER_INSTALL_PATH=/absolute/path/to/dependencies/install
  - -DNAMESPACE=WPEFramework
- Callsigns: The integration plugin expects AppGateway registered as org.rdk.AppGateway or AppGateway.
- Runtime notes: Integration tests require a running Thunder/WPEFramework instance and proper plugin configuration for AppGateway and App2AppProviderTest. This repository provides the test plugin build but not a full Thunder runtime bootstrap.

## CI Integration
- CTest-based discovery and execution: Tests are registered via add_test in app-gateway/tests/CMakeLists.txt and are discovered by CTest automatically in the configured build directory. Locally, mimic CI by invoking:
  - cmake .. && cmake --build . && ctest --output-on-failure
- CI config files: None are present in this repository. A typical CI pipeline would:
  - Prepare dependencies/install for WPEFramework
  - Configure CMake
  - Build
  - Run ctest with output-on-failure and possibly -VV for verbose logs

## Coverage
No coverage scripts are provided, but you can enable coverage with GCC/Clang using CMake cache variables in a clean build:
- cmake -S .. -B build-ottservices -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage" -DCMAKE_EXE_LINKER_FLAGS="--coverage"
- cmake --build build-ottservices
- cd build-ottservices && ctest --output-on-failure

Generate reports using lcov/genhtml if installed:
- lcov --directory . --capture --output-file coverage.info
- genhtml coverage.info --output-directory coverage-report

Note: Adjust paths to exclude external libraries and focus on app-gateway2 sources by passing appropriate --remove patterns to lcov.

## Debugging and Troubleshooting
- Thunder libs not found: If you see WPEFrameworkCore or WPEFrameworkPlugins not found, provide the absolute install path:
  - cmake -S .. -B build-ottservices -DTHUNDER_INSTALL_PATH=/abs/path/to/app-gateway2/dependencies/install
- Include path issues: Ensure include/WPEFramework exists under dependencies/install and that NAMESPACE is defined (defaults to WPEFramework).
- Linker errors: Confirm the correct library directory via THUNDER_LIBRARY_DIR or that the .so files exist under dependencies/install/lib.
- Flaky tests: Temporary files under /tmp might collide across concurrent runs. If needed, prefix with PID or unique suffixes; test_ottpermissioncache.cpp already uses getpid().
- Increase build verbosity:
  - cmake --build . -- VERBOSE=1
- Increase test verbosity:
  - ctest -V or ctest -VV

## Writing New Tests
- Location: app-gateway2/app-gateway/tests
- Add a new executable in CMakeLists.txt using add_executable and register it with add_test.
- Include Thunder headers via THUNDER_INCLUDE_DIR and project headers from ${PROJECT_SOURCE_DIR}.
- Define NAMESPACE at compile time if needed: target_compile_definitions(<target> PRIVATE NAMESPACE=${NAMESPACE})
- Keep tests self-contained and deterministic. Use temporary files in /tmp with unique names and clean up after execution.
- Example snippet to register a test:
```cmake
add_executable(test_newfeature tests/test_newfeature.cpp)
target_include_directories(test_newfeature PUBLIC "${THUNDER_INCLUDE_DIR}")
target_compile_features(test_newfeature PRIVATE cxx_std_11)
target_compile_definitions(test_newfeature PRIVATE NAMESPACE=${NAMESPACE})
target_link_libraries(test_newfeature PRIVATE ${THUNDER_CORE_LIB} ${THUNDER_PLUGINS_LIB})
add_test(NAME NewFeature.Basic COMMAND test_newfeature)
```

## Maintaining Tests and Best Practices
- Keep assertions clear and provide actionable error messages via std::cerr.
- Avoid external network or system dependencies. Prefer local, deterministic inputs.
- Use environment variables to redirect file outputs in tests to avoid polluting developer environments.
- When adding new gateway features, create tests that cover both success and failure paths, and consider adding a plugin-level scenario if the feature impacts runtime behavior.

## Next Steps and Gap Analysis
- Automate integration testing: Provide a script or CTest target that launches a Thunder instance with AppGateway and loads App2AppProviderTest for basic smoke checks.
- Expand test coverage: Add tests around LaunchDelegate, AppNotifications, and network/user settings delegates.
- Unified test entrypoint: Consider a top-level CMake option to build both unit tests and the integration plugin in one command.
- Optional: Introduce a unit testing framework (e.g., GoogleTest) for richer assertions and reporting while preserving current CTest integration.

## References
- app-gateway2/app-gateway/tests/CMakeLists.txt
- app-gateway2/app-gateway/tests/test_appgateway.cpp
- app-gateway2/app-gateway/tests/test_fbcommon.cpp
- app-gateway2/app-gateway/tests/test_ottpermissioncache.cpp
- app-gateway2/app-gateway2_testing/CMakeLists.txt
- app-gateway2/app-gateway2_testing/App2AppProvider/App2AppProvider.cpp
- app-gateway2/app-gateway2_testing/App2AppProvider/App2AppProvider.h
- app-gateway2/app-gateway2_testing/App2AppProvider/App2AppProviderImplementation.cpp
- app-gateway2/app-gateway2_testing/App2AppProvider/App2AppProviderImplementation.h
- app-gateway2/app-gateway2_testing/App2AppProvider/IApp2AppProvider.h
- app-gateway2/app-gateway2_testing/App2AppProvider/Module.cpp
- app-gateway2/build-ottservices/tests/CTestTestfile.cmake
