# App-Gateway2 Testing Guide

## Overview
The app-gateway2 project includes two complementary testing areas:
- app-gateway2/tests under app-gateway contains unit and component tests for AppGateway and related modules built and executed using CTest via CMake.
- app-gateway2_testing contains a lightweight Thunder plugin built as a shared library (App2AppProviderTest.so). This plugin is designed to facilitate integration testing of App2App provider patterns against an AppGateway instance by providing a minimal, test-focused implementation.

Together, these areas enable validation of internal logic (e.g., ResolutionStore and Resolver behavior, permission cache) and provider-to-gateway interactions typical in Firebolt provider patterns.

## Directory Structure
- app-gateway2/app-gateway2_testing
  - CMakeLists.txt: Builds a shared library named App2AppProviderTest from the App2AppProvider sources and links against WPEFrameworkCore and WPEFrameworkPlugins from dependencies/install.
  - App2AppProvider/
    - App2AppProvider.cpp: Thunder plugin class implementing PluginHost::IPlugin, with lifecycle (Initialize, Deinitialize), reference counting, and interface querying. It acquires the AppGateway interface via IShell by callsign.
    - App2AppProvider.h: Plugin class declaration and wiring to Exchange::IApp2AppProvider.
    - App2AppProviderImplementation.{h,cpp}: Encapsulates the actual provider logic and implements Exchange::IApp2AppProvider for testing. (Used by the plugin wrapper.)
    - IApp2AppProvider.h: Test-local Exchange interfaces for App2AppProvider and a minimal IAppGateway subset, tailored to provider use in tests.
    - Module.cpp and UtilsLogging.h: Thunder module declaration and logging utilities.

- app-gateway2/app-gateway/tests
  - CMakeLists.txt: Defines test executables and registers them with CTest. Locates Thunder headers and libraries from dependencies/install and links tests to WPEFrameworkCore and WPEFrameworkPlugins (and to the AppGateway plugin target when available).
  - test_appgateway.cpp: Tests ResolutionStore, Resolver, and RequestRouter.
  - test_fbcommon.cpp: Tests resolution overlay behavior using FbCommon/Resolver.
  - test_ottpermissioncache.cpp: Tests OttPermissionCache correctness and idempotency.

- app-gateway2/build-ottservices/tests
  - CTestTestfile.cmake: Generated by CMake. Registers tests (e.g., AppGateway.Basic) for execution with CTest after building.

## How to Run Tests
The repository uses standard CMake/CTest flows. There are two typical paths:

1) Run the unit/component tests under app-gateway:
- Configure and build in a separate build directory (recommended):
  - mkdir -p app-gateway2/build-ottservices
  - cd app-gateway2/build-ottservices
  - cmake .. (or cmake -S .. -B .) ensuring that dependencies/install is present under app-gateway2
  - cmake --build .
- Execute tests:
  - ctest --output-on-failure
- The generated file build-ottservices/tests/CTestTestfile.cmake shows registered tests such as:
  - AppGateway.Basic -> runs the test_appgateway executable
  - FbCommon.Resolutions -> runs the test_fbcommon executable
  - OttPermissionCache.Idempotent -> runs the test_ottpermissioncache executable

2) Build and load the test plugin from app-gateway2_testing:
- Configure and build the plugin:
  - cd app-gateway2/app-gateway2_testing
  - mkdir -p build && cd build
  - cmake ..
  - cmake --build .
- The output is a shared library: App2AppProviderTest.so (no lib prefix), linked to WPEFrameworkCore and WPEFrameworkPlugins from dependencies/install.
- Use this shared library in a Thunder/WPEFramework environment to validate provider/gateway flows (e.g., load alongside AppGateway and exercise provider registration and responses). The plugin calls QueryInterfaceByCallsign for "org.rdk.AppGateway" and falls back to "AppGateway", so ensure the AppGateway plugin is active under one of those callsigns.

Notes:
- The tests under app-gateway/tests are integrated with CTest and run standalone as normal executables.
- The app-gateway2_testing plugin is not a CTest-based test. It is a support module for manual or integration style validation in a Thunder runtime.

## Test Strategy & Coverage
- Unit and Component Tests:
  - Resolution and Routing: test_appgateway.cpp exercises ResolutionStore, Resolver, and RequestRouter paths.
  - Resolver Overlays: test_fbcommon.cpp validates resolution overlay loading from JSON and correct alias/event mapping behavior.
  - Permission Cache: test_ottpermissioncache.cpp validates OttPermissionCache behavior, file format persistence, and idempotency.
- Provider Integration:
  - The App2AppProviderTest plugin provides a minimal Exchange::IApp2AppProvider implementation and relays responses using a minimal IAppGateway subset defined in IApp2AppProvider.h. This enables end-to-end verification of provider registration, invocation, response, and error handling against a live AppGateway instance in a Thunder runtime.

This strategy ensures internal correctness (logic/unit tests) and realistic provider-to-gateway interactions (integration via a Thunder plugin).

## CI Integration
- CTest Integration:
  - The tests in app-gateway/tests are registered with add_test in CMakeLists.txt and are compatible with any CI that invokes ctest after a successful build.
  - The example generated CTestTestfile.cmake shows AppGateway.Basic is registered; additional tests (FbCommon.Resolutions, OttPermissionCache.Idempotent) are also configured.
- External CI:
  - No project-wide CI configuration (e.g., GitHub Actions, Jenkinsfile) is present here. Integrating into CI typically involves:
    - Configure CMake with the Thunder dependencies path
    - Build targets
    - Run ctest with output-on-failure

## Environment and Configuration Requirements
- Thunder/WPEFramework Dependencies:
  - The project expects Thunder (WPEFramework) headers and libraries under app-gateway2/dependencies/install:
    - include/WPEFramework (or include/<NAMESPACE>) and lib containing WPEFrameworkCore, WPEFrameworkPlugins
- Namespaces and Callsigns:
  - The tests define NAMESPACE=WPEFramework by default to match Thunder conventions.
  - The test plugin queries the AppGateway by callsign "org.rdk.AppGateway" and falls back to "AppGateway".
- Build Tooling:
  - CMake 3.10 or newer (as required by the CMakeLists in testing areas).
  - A standard C++ toolchain with C++11 or higher support (C++17 is used for the test plugin).

If the Thunder dependencies are not found, app-gateway/tests/CMakeLists.txt will fail with a clear message to install or point to the correct location.

## Next Steps and Recommendations
- Automate App2AppProviderTest usage:
  - Provide scripted instructions or a CTest-driven integration harness that spins up Thunder with AppGateway and loads App2AppProviderTest to run integration assertions programmatically.
- Expand Coverage:
  - Add tests for LaunchDelegate, AppNotifications, and network/user settings delegates, including positive and negative paths.
  - Increase coverage for gateway request/response flows with realistic payloads and error scenarios.
- Unify Build Entrypoints:
  - Expose a top-level test build target to build both the unit tests and the App2AppProviderTest plugin, easing developer workflows.
- CI Enhancements:
  - Add a CI configuration that:
    - Caches Thunder dependencies
    - Builds app-gateway tests and runs ctest
    - Optionally provisions a Thunder runtime to load App2AppProviderTest for integration checks

## References
- app-gateway2/app-gateway2_testing/CMakeLists.txt
- app-gateway2/app-gateway2_testing/App2AppProvider/App2AppProvider.cpp
- app-gateway2/app-gateway2_testing/App2AppProvider/App2AppProvider.h
- app-gateway2/app-gateway2_testing/App2AppProvider/IApp2AppProvider.h
- app-gateway2/app-gateway2_testing/App2AppProvider/Module.cpp
- app-gateway2/app-gateway/tests/CMakeLists.txt
- app-gateway2/build-ottservices/tests/CTestTestfile.cmake
